#!/bin/bash

# The Collective Strategist - Production Deployment Script
# This script handles the complete deployment process

set -e

# Configuration
COMPOSE_FILE="docker-compose.collective-strategist.yml"
BACKUP_DIR="./backups"
LOG_FILE="./logs/deploy-$(date +%Y%m%d-%H%M%S).log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$LOG_FILE"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOG_FILE"
    exit 1
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1" | tee -a "$LOG_FILE"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1" | tee -a "$LOG_FILE"
}

# Pre-deployment checks
check_prerequisites() {
    log "Checking prerequisites..."
    
    # Check if Docker is installed and running
    if ! command -v docker &> /dev/null; then
        error "Docker is not installed. Please install Docker first."
    fi
    
    if ! docker info &> /dev/null; then
        error "Docker is not running. Please start Docker first."
    fi
    
    # Check if Docker Compose is available
    if ! command -v docker-compose &> /dev/null; then
        error "Docker Compose is not installed. Please install Docker Compose first."
    fi
    
    # Check if required files exist
    if [[ ! -f "$COMPOSE_FILE" ]]; then
        error "Docker Compose file not found: $COMPOSE_FILE"
    fi
    
    # Check if production environment file exists
    if [[ ! -f ".env.production" ]]; then
        error "Production environment file not found: .env.production"
        echo "Please create .env.production with secure passwords. See .env.production for template."
    fi
    
    # Check for placeholder passwords
    if grep -q "CHANGE_ME_BEFORE_DEPLOYMENT" .env.production; then
        error "Production environment contains placeholder passwords. Please update .env.production with secure values."
    fi
    
    # Check for secrets
    if [[ ! -f "./secrets/jwt_secret.txt" ]]; then
        warning "JWT secret not found. Generating a new one..."
        mkdir -p ./secrets
        openssl rand -base64 64 > ./secrets/jwt_secret.txt
        chmod 600 ./secrets/jwt_secret.txt
    fi
    
    success "Prerequisites check passed!"
}

# Build and deploy
deploy() {
    log "Starting deployment..."
    
    # Create necessary directories
    mkdir -p logs uploads backups
    
    # Build the application
    log "Building The Collective Strategist..."
    docker-compose --env-file .env.production -f "$COMPOSE_FILE" build --no-cache
    
    # Start the services
    log "Starting services..."
    docker-compose -f "$COMPOSE_FILE" up -d
    
    # Wait for services to be healthy
    log "Waiting for services to be ready..."
    sleep 30
    
    # Check service health
    check_health
    
    success "Deployment completed successfully!"
}

# Health check
check_health() {
    log "Performing health checks..."
    
    # Check if containers are running
    if ! docker-compose -f "$COMPOSE_FILE" ps | grep -q "Up"; then
        error "Some services failed to start properly"
    fi
    
    # Check database connectivity
    if docker-compose -f "$COMPOSE_FILE" exec -T postgres pg_isready -U strategist -d collective_strategist; then
        success "Database is healthy"
    else
        error "Database health check failed"
    fi
    
    # Check Redis connectivity
    if docker-compose -f "$COMPOSE_FILE" exec -T redis redis-cli --no-auth-warning -a strategist_redis_2024 ping | grep -q "PONG"; then
        success "Redis is healthy"
    else
        error "Redis health check failed"
    fi
    
    # Check frontend accessibility
    sleep 10
    if curl -f -s http://localhost:3000/health > /dev/null; then
        success "Frontend is accessible"
    else
        warning "Frontend health check failed - may need more time to start"
    fi
    
    # Check API accessibility
    if curl -f -s http://localhost:8007/health > /dev/null; then
        success "API is accessible"
    else
        warning "API health check failed - may need more time to start"
    fi
}

# Backup database
backup_database() {
    log "Creating database backup..."
    
    BACKUP_FILE="$BACKUP_DIR/collective_strategist_$(date +%Y%m%d_%H%M%S).sql"
    
    docker-compose -f "$COMPOSE_FILE" exec -T postgres pg_dump \
        -U strategist \
        -d collective_strategist \
        --clean --if-exists \
        > "$BACKUP_FILE"
    
    if [[ -f "$BACKUP_FILE" ]]; then
        success "Database backup created: $BACKUP_FILE"
    else
        error "Database backup failed"
    fi
}

# Rollback function
rollback() {
    log "Rolling back deployment..."
    
    docker-compose -f "$COMPOSE_FILE" down
    
    # Restore from latest backup if available
    LATEST_BACKUP=$(ls -t "$BACKUP_DIR"/*.sql 2>/dev/null | head -n1)
    if [[ -n "$LATEST_BACKUP" ]]; then
        log "Restoring from backup: $LATEST_BACKUP"
        # Restore database logic here
    fi
    
    success "Rollback completed"
}

# Show deployment status
status() {
    log "Checking deployment status..."
    
    echo -e "\n${BLUE}=== Container Status ===${NC}"
    docker-compose -f "$COMPOSE_FILE" ps
    
    echo -e "\n${BLUE}=== Service URLs ===${NC}"
    echo "Frontend: http://localhost:3000"
    echo "API: http://localhost:8007"
    echo "Grafana: http://localhost:3001 (admin/strategist_grafana_2024)"
    echo "Prometheus: http://localhost:9090"
    
    echo -e "\n${BLUE}=== Resource Usage ===${NC}"
    docker-compose -f "$COMPOSE_FILE" top
}

# Show logs
logs() {
    local service=${1:-}
    if [[ -n "$service" ]]; then
        docker-compose -f "$COMPOSE_FILE" logs -f "$service"
    else
        docker-compose -f "$COMPOSE_FILE" logs -f
    fi
}

# Main script logic
case "${1:-deploy}" in
    "deploy")
        check_prerequisites
        backup_database || true  # Don't fail if no existing database
        deploy
        ;;
    "health")
        check_health
        ;;
    "status")
        status
        ;;
    "backup")
        backup_database
        ;;
    "rollback")
        rollback
        ;;
    "logs")
        logs "${2:-}"
        ;;
    "stop")
        log "Stopping services..."
        docker-compose -f "$COMPOSE_FILE" down
        success "Services stopped"
        ;;
    "update")
        log "Updating deployment..."
        backup_database
        docker-compose -f "$COMPOSE_FILE" pull
    docker-compose --env-file .env.production -f "$COMPOSE_FILE" up -d
        check_health
        success "Update completed"
        ;;
    *)
        echo "Usage: $0 {deploy|health|status|backup|rollback|logs|stop|update}"
        echo ""
        echo "Commands:"
        echo "  deploy  - Full deployment (default)"
        echo "  health  - Check service health"
        echo "  status  - Show deployment status"
        echo "  backup  - Create database backup"
        echo "  rollback- Rollback deployment"
        echo "  logs    - Show logs (optionally for specific service)"
        echo "  stop    - Stop all services"
        echo "  update  - Update and restart services"
        exit 1
        ;;
esac